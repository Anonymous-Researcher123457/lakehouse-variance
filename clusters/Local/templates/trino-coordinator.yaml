apiVersion: v1
kind: Pod
metadata:
  name: trino-coord-pod-{{ .Values.instanceName }}
  namespace: { { .Values.namespace } }
  labels:
    pod: trino-pod-{{ .Values.instanceName }}
spec:
  {{- if .Values.trino.coord.nodeName }}
  nodeName: {{ .Values.trino.coord.nodeName | quote }}
  {{- end }}

  serviceAccountName: {{ .Values.trino.serviceAccountName | quote }}

  containers:
    - name: node-exporter
      image: quay.io/prometheus/node-exporter:v1.8.1
      args:
        - --path.procfs=/proc
        - --path.sysfs=/sys
        - --path.rootfs=/host
        - --collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($|/)
      ports:
        - containerPort: 9100
      securityContext:
        capabilities:
          drop:
            - MKNOD

    - name: trino-coord
      image: {{ .Values.trino.pod.image | quote }}
      env:
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
      command:
        - /bin/sh
        - -c
        - |
          exec /lib/trino/bin/run-trino &
          /mnt/primary/Mini-project/Apache/System/Probe/trino_probe.sh "{{ .Values.instanceName }}" "$POD_NAME"
      ports:
        - { containerPort: 7071, protocol: TCP }
        - { containerPort: 8080 }
        - { containerPort: 9100 }
        - { containerPort: 9189 }
        - { containerPort: 9090, protocol: TCP }
        - { containerPort: 9101, protocol: TCP }
        - { containerPort: 9102, protocol: TCP }
        - { containerPort: 9103, protocol: TCP }
        - { containerPort: 9104, protocol: TCP }
      volumeMounts:
        - name: {{ .Values.pvc.iceberg.name }}
          mountPath: {{ .Values.pvc.iceberg.path | quote }}
        - name: trino-iceberg-config-{{ .Values.instanceName }}
          mountPath: /etc/trino/catalog/iceberg.properties
          subPath: iceberg.properties
        - name: trino-coord-config-{{ .Values.instanceName }}
          mountPath: /etc/trino/config.properties
          subPath: config.properties
        - name: trino-jvm-config
          mountPath: /etc/trino/jvm.config
          subPath: jvm.config
        - name: trino-jmx-config
          mountPath: /etc/jmx-exporter-config.yml
          subPath: jmx-exporter-config.yml
      securityContext:
        capabilities:
          drop:
            - MKNOD
      imagePullPolicy: IfNotPresent
      resources:
        requests:
          cpu: {{ .Values.trino.coord.resources.cpu | quote }}
          memory: {{ .Values.trino.coord.resources.memory | quote }}
        limits:
          cpu: {{ .Values.trino.coord.resources.cpu | quote }}
          memory: {{ .Values.trino.coord.resources.memory | quote }}

  volumes:
    - name: {{ .Values.pvc.iceberg.name }}
      persistentVolumeClaim:
        claimName: {{ .Values.pvc.iceberg.name }}
    - name: trino-iceberg-config-{{ .Values.instanceName }}
      configMap:
        name: trino-iceberg-config-{{ .Values.instanceName }}
    - name: trino-coord-config-{{ .Values.instanceName }}
      configMap:
        name: trino-coord-config-{{ .Values.instanceName }}
    - name: trino-jvm-config
      configMap:
        name: trino-jvm-config
    - name: trino-jmx-config
      configMap:
        name: trino-jmx-config
